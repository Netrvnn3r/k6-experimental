/**
 * K6 Performance Test â€” Auto-generated from BDD Feature
 * 
 * Feature: Flujo de AutenticaciÃ³n
 * Scenario: Test de carga del login [Load Test â€” Row 1]
 * Examples: Load Test
 * Parameters: {"vus":"20","duration":"2m","threshold_p95":"2000","failure_rate":"5"}
 * 
 * Generated at: 2026-02-18T15:06:40.546Z
 * âš ï¸  DO NOT EDIT â€” This file is auto-generated by the BDD runner.
 *     Edit the .feature file and step definitions instead.
 */

import { sleep, group } from 'k6';
import http from 'k6/http';
import { check } from 'k6';
import { Trend, Rate } from 'k6/metrics';
import { BASE_URL } from '../../lib/config.js';
import { getTimestamp } from '../../lib/helpers.js';
import { htmlReport } from 'https://raw.githubusercontent.com/benc-uk/k6-reporter/main/dist/bundle.js';
import { textSummary } from 'https://jslib.k6.io/k6-summary/0.1.0/index.js';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CUSTOM METRICS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const loginDuration = new Trend('login_duration', true);
const logoutDuration = new Trend('logout_duration', true);
const authFailures = new Rate('auth_failure_rate');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// OPTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export const options = {
    "scenarios": {
        "test_de_carga_del_login_load_test_row_1": {
            "executor": "ramping-vus",
            "startVUs": 2,
            "stages": [
                {
                    "duration": "24s",
                    "target": 20
                },
                {
                    "duration": "78s",
                    "target": 20
                },
                {
                    "duration": "18s",
                    "target": 0
                }
            ]
        }
    },
    "thresholds": {
        "login_duration": [
            "p(95)<2000"
        ],
        "http_req_failed": [
            "rate<0.05"
        ]
    }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DEFAULT â€” Test de carga del login [Load Test â€” Row 1]
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default function () {
    group('Dado el sistema estÃ¡ disponible', function () {
        
            // VerificaciÃ³n: el sistema responde
            console.log('âœ… Sistema disponible â€” iniciando test');
    });
    group('Cuando 20 usuarios realizan login durante "2m"', function () {
        
            // Login action â€” VUs: 20, Duration: 2m
            const loginStart = Date.now();
            const loginUrl = `${BASE_URL}/api/auth`;
            const loginPayload = JSON.stringify({
                username: __ENV.USERNAME || 'ghauyon',
                password: __ENV.PASSWORD || 'user4Test',
            });
            const loginRes = http.post(loginUrl, loginPayload, {
                headers: { 'Content-Type': 'application/json' },
                tags: { name: 'AUTH_Login' },
            });
            loginDuration.add(Date.now() - loginStart);
        
            const loginOk = check(loginRes, {
                'login: status 200': (r) => r.status === 200,
                'login: tiene token': (r) => {
                    try { return JSON.parse(r.body).data.token !== undefined; }
                    catch (e) { return false; }
                },
            });
            if (!loginOk) {
                authFailures.add(1);
                return;
            }
            authFailures.add(0);
            const token = JSON.parse(loginRes.body).data.token;
            sleep(1);
        
            // Logout
            const logoutStart = Date.now();
            http.del(loginUrl, null, {
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                tags: { name: 'AUTH_Logout' },
            });
            logoutDuration.add(Date.now() - logoutStart);
            sleep(2);
    });
    group('Entonces el percentil 95 del login debe ser menor a 2000ms', function () {
        
            // Threshold assertion: login p95 < 2000ms (enforced via k6 thresholds)
    });
    group('Y la tasa de fallas debe ser menor a 5%', function () {
        
            // Threshold assertion: failure rate < 5% (enforced via k6 thresholds)
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TEARDOWN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export function teardown() {
    console.log('ğŸ Test BDD completado: Test de carga del login [Load Test â€” Row 1]');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export function handleSummary(data) {
    const ts = getTimestamp();
    return {
        [`reports/bdd-test-de-carga-del-login-load-test-row-1_${ts}.html`]: htmlReport(data),
        [`reports/bdd-test-de-carga-del-login-load-test-row-1_${ts}.json`]: JSON.stringify(data, null, 2),
        stdout: textSummary(data, { indent: ' ', enableColors: true }),
    };
}