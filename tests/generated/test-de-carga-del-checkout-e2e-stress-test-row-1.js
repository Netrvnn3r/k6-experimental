/**
 * K6 Performance Test â€” Auto-generated from BDD Feature
 * 
 * Feature: Flujo de Checkout
 * Scenario: Test de carga del checkout E2E [Stress Test â€” Row 1]
 * Examples: Stress Test
 * Parameters: {"vus":"30","duration":"3m","quantity":"2","threshold_p95":"8000","success_rate":"50","failure_rate":"25"}
 * 
 * Generated at: 2026-02-18T14:54:53.970Z
 * âš ï¸  DO NOT EDIT â€” This file is auto-generated by the BDD runner.
 *     Edit the .feature file and step definitions instead.
 */

import { sleep } from 'k6';
import http from 'k6/http';
import { check } from 'k6';
import { Trend, Rate, Counter } from 'k6/metrics';
import { BASE_URL } from '../../lib/config.js';
import { login } from '../../lib/auth.js';
import { getProducts, createOrder, getOrders } from '../../lib/endpoints.js';
import { randomItem, randomInt, randomThinkTime, getTimestamp } from '../../lib/helpers.js';
import { htmlReport } from 'https://raw.githubusercontent.com/benc-uk/k6-reporter/main/dist/bundle.js';
import { textSummary } from 'https://jslib.k6.io/k6-summary/0.1.0/index.js';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CUSTOM METRICS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const checkoutDuration = new Trend('checkout_duration', true);
const productSearchForCheckout = new Trend('product_search_for_checkout', true);
const orderVerifyDuration = new Trend('order_verify_duration', true);
const checkoutSuccessRate = new Rate('checkout_success_rate');
const stockConflicts = new Counter('stock_conflicts_409');
const totalOrdersCreated = new Counter('total_orders_created');
const e2eCheckoutDuration = new Trend('e2e_checkout_duration', true);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// OPTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export const options = {
    "scenarios": {
        "test_de_carga_del_checkout_e2e_stress_te": {
            "executor": "ramping-vus",
            "startVUs": 3,
            "stages": [
                {
                    "duration": "36s",
                    "target": 30
                },
                {
                    "duration": "117s",
                    "target": 30
                },
                {
                    "duration": "27s",
                    "target": 0
                }
            ]
        }
    },
    "thresholds": {
        "checkout_duration": [
            "p(95)<8000"
        ],
        "checkout_success_rate": [
            "rate>0.5"
        ],
        "http_req_failed": [
            "rate<0.25"
        ]
    }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SETUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export function setup() {
    const token = login();
    if (!token) throw new Error('Authentication failed.');
    const skuPool = [];
    for (let page = 1; page <= 3; page++) {
        const result = getProducts(token, { page, pageSize: 50 });
        if (result && result.data && result.data.items) {
            result.data.items.forEach((p) => {
                if (p.stock > 0) {
                    skuPool.push({ sku: p.sku, stock: p.stock, name: p.name });
                }
            });
        }
    }
    console.log(`ğŸ›’ Setup: ${skuPool.length} SKUs con stock disponible`);
    return { token, skuPool };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DEFAULT â€” Test de carga del checkout E2E [Stress Test â€” Row 1]
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default function (data) {
    // SKU pool cargado en setup()
    const { token, skuPool } = data;
    if (!skuPool || skuPool.length === 0) {
        console.warn('âš ï¸ No SKUs con stock disponible');
        return;
    }

    // Checkout with 2 product(s)
    const { token, skuPool } = data;
    const e2eStart = Date.now();

    // Browse for products
    const browseStart = Date.now();
    const productsData = getProducts(token, { page: randomInt(1, 5), pageSize: 10 });
    productSearchForCheckout.add(Date.now() - browseStart);
    sleep(randomThinkTime(1, 2));

    // Select product
    let selectedSku;
    if (productsData && productsData.data && productsData.data.items) {
        const available = productsData.data.items.filter(p => p.stock > 0);
        if (available.length > 0) selectedSku = randomItem(available).sku;
    }
    if (!selectedSku && skuPool && skuPool.length > 0) {
        selectedSku = randomItem(skuPool).sku;
    }
    if (!selectedSku) {
        console.warn('âš ï¸ No SKU disponible para checkout');
        checkoutSuccessRate.add(0);
        return;
    }
    sleep(randomThinkTime(0.5, 1));

    // Place order
    const quantity = 2;
    const checkoutStart = Date.now();
    const orderRes = createOrder(token, [{ sku: selectedSku, quantity }],
        `bdd-test-${Date.now()}@loadtest.com`);
    checkoutDuration.add(Date.now() - checkoutStart);

    if (orderRes.status === 200) {
        checkoutSuccessRate.add(1);
        totalOrdersCreated.add(1);
        // Verify order
        sleep(randomThinkTime(0.5, 1));
        const verifyStart = Date.now();
        getOrders(token, { page: 1, pageSize: 5 });
        orderVerifyDuration.add(Date.now() - verifyStart);
    } else if (orderRes.status === 409) {
        stockConflicts.add(1);
        checkoutSuccessRate.add(0);
    } else {
        checkoutSuccessRate.add(0);
    }
    e2eCheckoutDuration.add(Date.now() - e2eStart);
    sleep(randomThinkTime(1, 3));

    // Threshold assertion: checkout p95 < 8000ms

    // Threshold assertion: checkout success rate > 50%

    // Threshold assertion: failure rate < 25% (enforced via k6 thresholds)
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TEARDOWN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export function teardown(data) {
    console.log('ğŸ Test BDD completado: Test de carga del checkout E2E [Stress Test â€” Row 1]');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export function handleSummary(data) {
    const ts = getTimestamp();
    return {
        [`reports/bdd-test-de-carga-del-checkout-e2e-stress-test-row-1_${ts}.html`]: htmlReport(data),
        [`reports/bdd-test-de-carga-del-checkout-e2e-stress-test-row-1_${ts}.json`]: JSON.stringify(data, null, 2),
        stdout: textSummary(data, { indent: ' ', enableColors: true }),
    };
}